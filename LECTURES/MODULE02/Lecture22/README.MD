OTUS 202105181

# BGP #

![](pictures/01.jpg)

# ОСНОВЫ #
- IGP (ISIS/OSPF/RIP/EIGRP)
- EGP (BGP)

![](pictures/02.jpg)

![](pictures/03.jpg)

Для взаимодействия между AS настроен BGP. По-сути это монополист в интернете. AS [autonomous system] - оборудолвание/сети, управляемые одной компанией, или под управлением нескольких организаций, имеющих общие концепции (наcтройки BGP и все исходящие из неё )

![](pictures/04.jpg)

![](pictures/05.jpg)

RIR - Организации отвечающие за работу сетей/AS в конкретном регионе (региональная регистратура). В каждом регионе - своя. За европейскую часть отвечают - RIPE. И с ней взаимодействовать можно как через провайдера, так и самостоятельно (в рублях - 60000/год за поддержание AS)

![](pictures/06.jpg)

IANA/RIR - выпускают отчеты об использовании адресного пространства

Анонсировать адреса можно из любого географической области.

Под RIR - LIR,  и уже LIR имеет AS и адресное пространство. LIR работает с LIR.

looking glass - етсь не у всех провайдеров, для снятия статистики:
- https://www.msk-ix.ru/lookingglass/
- https://bgp.he.net/

![](pictures/07.jpg)

# Расширенная информация о BGP#

![](pictures/08.jpg)

IPv4 купить уже нельзя, остается толькоарендовать у провайдеров. AS могут управлять несколько операторов (дочерние компании). Головная компания управляет всеми концепциями. Ненкоторые провайдеры успели понабрать себе AS (вместе с сетями), которые теперь могут делегировать клиентам (актуально для IPv6, для IPv4 - уже нельзя). 

BGP
- iBGP - внутри AS
- eBGP - между AS

## AS ##
AS - это некий номер, прогресс выдавания номеров AS - представлен ниже.

![](pictures/09.jpg)

До 2012 года выдавались AS 1 - 64495, сейчас уже выдаются  из 2-го диапазона.

Приватные номера AS ___64512 - 65534___ - немаршрутизируемые, в целом они нужны для работы внутри моей AS. Назначаю их я сам.

23456 - для работы старого оборудования, которое умеет работать только с 16-битным номерами AS. Таким номером старое оборудрование дает понять что пришедший 32-битный номер AS оно не в состоянии переварить.

![](pictures/10.jpg)

В RFC 4893 появилось понятие ___mappable ASN___, т.е. AS, которые имеют значение 0-65532 (к этим значениям спереди дописывают 16 нулей)

Виды записи ASN отличаются:
- 0 - 4294967295
- как нуль и последующее значение (разность номера AS и 65535)

![](pictures/11.jpg)

## Это DV протокол ##

Маршрутизатор настраивают таким образом, что он начинает понимать что какая сеть находится в какой AS. Причем путь до конечной AS называется AS-PATH, который составляется из всех проходных AS.

![](pictures/12.jpg)

![](pictures/13.jpg)

AS-PATH может использоваться для:
- Предотвращение петель (если update придет с информацией о собственной AS)
- Фильтрация
- Выбор минимального пути (логика RIP). В таблице маршрутов будут все пути, но в таблице маршрутизации  - лучший
- AS-Prepend (повторение номера зоны AS 300,300,300,300, что позволяет создать более емкий, фейковый, путь и выбрать лучший). - распределение трафика, когда трафики разделяются через разные линкИ
- Соединение AS через промежуточную AS

![](pictures/14.jpg)

## Соседство/смежность ##
В BGP нет необходимости непосредственной связи AS. Достаточно только IP-связности

![](pictures/15.jpg)

### состояние смежности ###
- IDLE - изначальное состояние соседство
- CONNECT - слушаем порт 179, но ничего не отправляем
- ACTIVE - отправляем SYN и ждем ответа соседа
- OPENSENT** - BGP начинает работать, обменивается сообщениями OPEN
- OPENCONFIRM ** - сообщение OPEN получено
- ESTABLISHED - все настройки согласованы и сессия BGP работает

![](pictures/16.jpg)

### Сообщения BGP ###
- OPEN - соглаосвание нмоеров AS, Hold Time, RID
- Notification - для разрыва BGP - сессии
- UPDATE - основные сообщения, с кусками маршрутной информации BGP
- keepalive
   - оповещение что сосед еще жив или 
   - подтверждение на UPDATE. Если не получаем подтверждением, сбрасываем соседство
- ROUTE REFRESH - запрос маршрутов, без перезапуска BGP (маршрутизация бедет выполняться по старой ьаблице маршрутизации).

![](pictures/17.jpg)

- На первом этапе раюотает TCP
- На втором этапе работает BGP, происходит обмен между вручную настроенными соседями, с подтверждением keepalive

![](pictures/18.jpg)

## Маршрутная карта BGP ##

![](pictures/19.jpg)

если от соседа keepalive нет, то разрываем соседство

## Концепция обработки маршрутов BGP ##

![](pictures/20.jpg)

![](pictures/23.jpg)

Маршруты в LOC-RIB могут попасть к нам:
   - Статические/известные маршруты  (directly/static)/через проверку BGP RIB Check
   - Adj-RIB-In - входящие от соседей маршруты
LOC-RIB/FIB - BGP Database, база данных существующих маршрутов

из LOC-RIB маршруты в таблицу маршрутизации попадают:
   - через проверку 
      - next-hop (маршрут в текущей таблице маршрутизации)
      - validity Check
   - Выбор лучшего пути (только одного). Лучший путь 
      - попадает в таблицу маршрутизации
      - табличку маршрутов для соседа (на основании которой готовится информация для соседа)

![](pictures/21.jpg)

![](pictures/24.jpg)

![](pictures/25.jpg)



