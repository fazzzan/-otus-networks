OTUS 20210521

# BGP #

![](pictures/01.jpg)

маршруты в Loc-RIB могут попадать 2 путями (из разных источников):
   1. Маршруты connected/redistribute  попадают в RIB через RIB check (наличие маршрута в таблице маршрутизации)
   2. Маршруты приходящие от соседей: проверка может быть либо по Inbound Route Policy, либо на наличие AS в записях Ripe.
Маршруты из Loc-RIB проходят проверку: 
   - ___Next-Hop___ - есть ли маршщрут к next-hop
   - ___Validity Check___ - маршрут некорректный по каким-то признакам
Происходит выбор лучшего (BGP Best Path). И данный маршрут проходит как в таблицу маршрутов и направляются на отправку соседям.

## Атрибуты BGP  ##

В BGP нет метрик, и поэтому какие-то способы управления можно выполнить только через атрибуты, которых 4 группы:
- обязательные (их должны понимать все производители)
   - mandatory
   - discretionary
      - local preference - рассказывает что какой-то путь более приоритетный

![](pictures/03.jpg)   

- Опциональные
   - transitive  - обязательно передается соседям
   - non-transitive - не передается соседям

![](pictures/04.jpg)

Ну и сводная табличка:

![](pictures/05.jpg)

Origin - как именно был получен маршрут

### Атрибут AS-Path ###
Описывает путь до сетей назначения
- перечисление через запятую номера AS (работает по логике RIP)
- Обнаружение петель (найди себя и если нашел - отбрось маршрут)

![](pictures/06.jpg)

Нюанс: в рамках одной AS, AS-Path меняться не будет, поэтому трафик до 1.1.1.1 может вернуться обратно (в рамках iBGP), поэтому существуют защитные механизмы.

![](pictures/07.jpg)

![](pictures/08.jpg)

### Атрибут Next-hop###
Его поведение для iBGP не совсем правльное: в рамках одной AS Next-hop  меняться не будет, и поэтому необходимо:
- организовать совместную работу iBGP и какого-либо IGP
- записать статический маршрут
- заанонсировать в рамках работающей iBGP ```next-hop self```

Для eBGP - такой проблемы нет

![](pictures/09.jpg)

Иногда возникает рекурсивная маршрутизация (маршрута конкретного нет, но есть опосредованные маршруты, которые будут ссылаться один на другой через next-hop)

![](pictures/10.jpg)

![](pictures/11.jpg)

Демонстрация того, что Next-hop не поменяется
![](pictures/12.jpg)

### Атрибут Local Preference ###
Работает внутри одной AS.  Настроив Local Preference на R2, мы сможем задать приоритет входящим обновлениям и заставить весь исходящие трафик выходить через R2

![](pictures/14.jpg)

![](pictures/13.jpg)

Демонстрация работы - пересмотреть заново, попробовать как оно работает с нуля